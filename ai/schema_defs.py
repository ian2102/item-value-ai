# Generated from chatGPT
effect_mapping = {
    "pp_Effect_ArmorPenetration": "primary_max_armor_penetration",
    "pp_Effect_ProjectileReductionMod": "primary_max_projectile_damage_reduction",
    "pp_Effect_RegularInteractionSpeed": "primary_max_regular_interaction_speed",
    "pp_Effect_MaxHealthAdd": "primary_max_max_health",
    "pp_Effect_PhysicalWeaponDamage": "primary_max_weapon_damage",
    "pp_Effect_Vigor": "primary_max_vigor",
    "pp_Effect_PhysicalDamageReduction": "primary_max_physical_damage_reduction",
    "pp_Effect_MoveSpeed": "primary_max_move_speed",
    "pp_Effect_HeadshotReductionMod": "primary_max_headshot_damage_reduction",
    "pp_Effect_Strength": "primary_max_strength",
    "pp_Effect_Dexterity": "primary_max_dexterity",
    "pp_Effect_Knowledge": "primary_max_knowledge",
    "pp_Effect_Will": "primary_max_will",
    "pp_Effect_MagicalHealing": "primary_max_magical_healing",
    "pp_Effect_DebuffDurationBonus": "primary_max_debuff_duration_bonus",
    "pp_Effect_BuffDurationBonus": "primary_max_buff_duration_bonus",
    "pp_Effect_ActionSpeed": "primary_max_action_speed",
    "pp_Effect_MagicalDamageReduction": "primary_max_magical_damage_reduction",
    "pp_Effect_Luck": "primary_max_luck",
    "pp_Effect_UndeadReductionMod": "primary_max_undead_damage_reduction",
    "pp_Effect_MoveSpeedBonus": "primary_max_move_speed_bonus",
    "pp_Effect_PhysicalDamageTrue": "primary_max_true_physical_damage",
    "pp_Effect_MagicPenetration": "primary_max_magic_penetration",
    "pp_Effect_Agility": "primary_max_agility",
    "pp_Effect_MagicalWeaponDamage": "primary_max_magic_weapon_damage",
    "pp_Effect_DemonDamageMod": "primary_max_demon_damage_bonus",
    "pp_Effect_HeadshotDamageMod": "primary_max_headshot_damage_bonus",
    "pp_Effect_MagicalDamageBonus": "primary_max_magical_damage_bonus",
    "pp_Effect_PhysicalPower": "primary_max_physical_power",
    "pp_Effect_UndeadDamageMod": "primary_max_undead_damage_bonus",
    "pp_Effect_MagicalDamage": "primary_max_magical_damage",
    "pp_Effect_MagicalPower": "primary_max_magical_power",
    "pp_Effect_ArmorRatingAdd": "primary_max_additional_armor_rating",
    "pp_Effect_ArmorRating": "primary_max_armor_rating",
    "pp_Effect_Resourcefulness": "primary_max_resourcefulness",
    "pp_Effect_MagicRegistance": "primary_max_magic_resistance",  # typo fixed
    "pp_Effect_MagicalDamageTrue": "primary_max_true_magical_damage",
    "pp_Effect_HeadshotDamageBonus": "primary_max_headshot_damage_bonus",
    "pp_Effect_DemonDamageBonus": "primary_max_demon_damage_bonus",
    "pp_Effect_DemonDamageReduction": "primary_max_demon_damage_reduction",
    "pp_Effect_UndeadDamageReduction": "primary_max_undead_damage_reduction",
    "sp_Effect_ArmorPenetration": "secondary_max_armor_penetration",
    "sp_Effect_ProjectileReductionMod": "secondary_max_projectile_damage_reduction",
    "sp_Effect_RegularInteractionSpeed": "secondary_max_regular_interaction_speed",
    "sp_Effect_MaxHealthAdd": "secondary_max_max_health",
    "sp_Effect_Vigor": "secondary_max_vigor",
    "sp_Effect_PhysicalDamageReduction": "secondary_max_physical_damage_reduction",
    "sp_Effect_DemonReductionMod": "secondary_max_demon_damage_reduction",
    "sp_Effect_PhysicalWeaponDamageAdd": "secondary_max_additional_weapon_damage",
    "sp_Effect_Strength": "secondary_max_strength",
    "sp_Effect_MoveSpeedAdd": "secondary_max_additional_move_speed",
    "sp_Effect_Dexterity": "secondary_max_dexterity",
    "sp_Effect_Knowledge": "secondary_max_knowledge",
    "sp_Effect_MemoryCapacityBonus": "secondary_max_memory_capacity_bonus",
    "sp_Effect_Will": "secondary_max_will",
    "sp_Effect_MagicalHealing": "secondary_max_magical_healing",
    "sp_Effect_ActionSpeed": "secondary_max_action_speed",
    "sp_Effect_DebuffDurationBonus": "secondary_max_debuff_duration_bonus",
    "sp_Effect_BuffDurationBonus": "secondary_max_buff_duration_bonus",
    "sp_Effect_MaxHealthBonus": "secondary_max_max_health_bonus",
    "sp_Effect_MagicalDamageReduction": "secondary_max_magical_damage_reduction",
    "sp_Effect_UndeadReductionMod": "secondary_max_undead_damage_reduction",
    "sp_Effect_MagicalDamageAdd": "secondary_max_additional_magical_damage",
    "sp_Effect_MoveSpeedBonus": "secondary_max_move_speed_bonus",
    "sp_Effect_PhysicalDamageTrue": "secondary_max_true_physical_damage",
    "sp_Effect_PhysicalDamageBonus": "secondary_max_physical_damage_bonus",
    "sp_Effect_MagicPenetration": "secondary_max_magic_penetration",
    "sp_Effect_PhysicalHealing": "secondary_max_physical_healing",
    "sp_Effect_Primitive": "secondary_max_primitive",
    "sp_Effect_PhysicalDamageAdd": "secondary_max_additional_physical_damage",
    "sp_Effect_CooldownReductionBonus": "secondary_max_cooldown_reduction_bonus",
    "sp_Effect_Agility": "secondary_max_agility",
    "sp_Effect_DemonDamageMod": "secondary_max_demon_damage_bonus",
    "sp_Effect_HeadshotDamageMod": "secondary_max_headshot_damage_bonus",
    "sp_Effect_MagicalDamageBonus": "secondary_max_magical_damage_bonus",
    "sp_Effect_PhysicalPower": "secondary_max_physical_power",
    "sp_Effect_UndeadDamageMod": "secondary_max_undead_damage_bonus",
    "sp_Effect_MagicalInteractionSpeed": "secondary_max_magical_interaction_speed",
    "sp_Effect_ArmorRatingAdd": "secondary_max_additional_armor_rating",
    "sp_Effect_MagicalPower": "secondary_max_magical_power",
    "sp_Effect_SpellCastingSpeed": "secondary_max_spell_casting_speed",
    "sp_Effect_Resourcefulness": "secondary_max_resourcefulness",
    "sp_Effect_MagicRegistance": "secondary_max_magic_resistance",  # typo fixed
    "sp_Effect_Luck": "secondary_max_luck",
    "sp_Effect_MemoryCapacityAdd": "secondary_max_additional_memory_capacity"
}

ppids = ['Effect_DemonDamageMod', 'Effect_Will', 'Effect_MaxHealthAdd', 'Effect_MagicPenetration', 'Effect_Resourcefulness', 'Effect_PhysicalPower', 'Effect_MagicalDamageBonus', 'Effect_MoveSpeedBonus', 'Effect_PhysicalDamageReduction', 'Effect_Strength', 'Effect_ProjectileReductionMod', 'Effect_Luck', 'Effect_Vigor', 'Effect_MagicalHealing', 'Effect_PhysicalDamageTrue', 'Effect_ArmorRatingAdd', 'Effect_MaxHealthBonus', 'Effect_PhysicalWeaponDamage', 'Effect_ArmorRating', 'Effect_Knowledge', 'Effect_MagicalWeaponDamage', 'Effect_UndeadDamageMod', 'Effect_MoveSpeed', 'Effect_Dexterity', 'Effect_HeadshotReductionMod', 'Effect_ActionSpeed', 'Effect_MagicalDamageTrue', 'Effect_MagicalDamageReduction', 'Effect_RegularInteractionSpeed', 'Effect_MagicalDamage', 'Effect_UndeadReductionMod', 'Effect_MagicRegistance', 'Effect_BuffDurationBonus', 'Effect_ArmorPenetration', 'Effect_DebuffDurationBonus', 'Effect_MagicalPower', 'Effect_HeadshotDamageMod', 'Effect_Agility']
spids = ['Effect_DemonDamageMod', 'Effect_Will', 'Effect_MemoryCapacityBonus', 'Effect_MaxHealthAdd', 'Effect_MagicPenetration', 'Effect_MagicalDamageBonus', 'Effect_PhysicalPower', 'Effect_Resourcefulness', 'Effect_SpellCastingSpeed', 'Effect_MoveSpeedBonus', 'Effect_PhysicalDamageReduction', 'Effect_MagicalDamageAdd', 'Effect_Strength', 'Effect_ProjectileReductionMod', 'Effect_Luck', 'Effect_MagicalHealing', 'Effect_Vigor', 'Effect_DemonReductionMod', 'Effect_MaxHealthBonus', 'Effect_ArmorRatingAdd', 'Effect_PhysicalDamageTrue', 'Effect_PhysicalWeaponDamageAdd', 'Effect_Knowledge', 'Effect_UndeadDamageMod', 'Effect_MemoryCapacityAdd', 'Effect_CooldownReductionBonus', 'Effect_Dexterity', 'Effect_PhysicalDamageBonus', 'Effect_MoveSpeedAdd', 'Effect_ActionSpeed', 'Effect_PhysicalDamageAdd', 'Effect_MagicalDamageTrue', 'Effect_MagicalDamageReduction', 'Effect_MagicalInteractionSpeed', 'Effect_RegularInteractionSpeed', 'Effect_UndeadReductionMod', 'Effect_MagicRegistance', 'Effect_BuffDurationBonus', 'Effect_PhysicalHealing', 'Effect_ArmorPenetration', 'Effect_DebuffDurationBonus', 'Effect_Primitive', 'Effect_MagicalPower', 'Effect_HeadshotDamageMod', 'Effect_Agility']

columns = ['message', 'rarity', 'name', 'id', 'value', 'pp_Effect_DemonDamageMod', 'pp_Effect_Will', 'pp_Effect_MaxHealthAdd', 'pp_Effect_MagicPenetration', 'pp_Effect_Resourcefulness', 'pp_Effect_PhysicalPower', 'pp_Effect_MagicalDamageBonus', 'pp_Effect_MoveSpeedBonus', 'pp_Effect_PhysicalDamageReduction', 'pp_Effect_Strength', 'pp_Effect_ProjectileReductionMod', 'pp_Effect_Luck', 'pp_Effect_Vigor', 'pp_Effect_MagicalHealing', 'pp_Effect_PhysicalDamageTrue', 'pp_Effect_ArmorRatingAdd', 'pp_Effect_MaxHealthBonus', 'pp_Effect_PhysicalWeaponDamage', 'pp_Effect_ArmorRating', 'pp_Effect_Knowledge', 'pp_Effect_MagicalWeaponDamage', 'pp_Effect_UndeadDamageMod', 'pp_Effect_MoveSpeed', 'pp_Effect_Dexterity', 'pp_Effect_HeadshotReductionMod', 'pp_Effect_ActionSpeed', 'pp_Effect_MagicalDamageTrue', 'pp_Effect_MagicalDamageReduction', 'pp_Effect_RegularInteractionSpeed', 'pp_Effect_MagicalDamage', 'pp_Effect_UndeadReductionMod', 'pp_Effect_MagicRegistance', 'pp_Effect_BuffDurationBonus', 'pp_Effect_ArmorPenetration', 'pp_Effect_DebuffDurationBonus', 'pp_Effect_MagicalPower', 'pp_Effect_HeadshotDamageMod', 'pp_Effect_Agility', 'sp_Effect_DemonDamageMod', 'sp_Effect_Will', 'sp_Effect_MemoryCapacityBonus', 'sp_Effect_MaxHealthAdd', 'sp_Effect_MagicPenetration', 'sp_Effect_MagicalDamageBonus', 'sp_Effect_PhysicalPower', 'sp_Effect_Resourcefulness', 'sp_Effect_SpellCastingSpeed', 'sp_Effect_MoveSpeedBonus', 'sp_Effect_PhysicalDamageReduction', 'sp_Effect_MagicalDamageAdd', 'sp_Effect_Strength', 'sp_Effect_ProjectileReductionMod', 'sp_Effect_Luck', 'sp_Effect_MagicalHealing', 'sp_Effect_Vigor', 'sp_Effect_DemonReductionMod', 'sp_Effect_MaxHealthBonus', 'sp_Effect_ArmorRatingAdd', 'sp_Effect_PhysicalDamageTrue', 'sp_Effect_PhysicalWeaponDamageAdd', 'sp_Effect_Knowledge', 'sp_Effect_UndeadDamageMod', 'sp_Effect_MemoryCapacityAdd', 'sp_Effect_CooldownReductionBonus', 'sp_Effect_Dexterity', 'sp_Effect_PhysicalDamageBonus', 'sp_Effect_MoveSpeedAdd', 'sp_Effect_ActionSpeed', 'sp_Effect_PhysicalDamageAdd', 'sp_Effect_MagicalDamageTrue', 'sp_Effect_MagicalDamageReduction', 'sp_Effect_MagicalInteractionSpeed', 'sp_Effect_RegularInteractionSpeed', 'sp_Effect_UndeadReductionMod', 'sp_Effect_MagicRegistance', 'sp_Effect_BuffDurationBonus', 'sp_Effect_PhysicalHealing', 'sp_Effect_ArmorPenetration', 'sp_Effect_DebuffDurationBonus', 'sp_Effect_Primitive', 'sp_Effect_MagicalPower', 'sp_Effect_HeadshotDamageMod', 'sp_Effect_Agility']

weapon_ids = ['FellingAxe_8001', 'Rapier_8001', 'Falchion_8001', 'Halberd_8001', 'DoubleAxe_8001', 'CrystalBall_8001', 'Buckler_8001', 'Longsword_8001', 'MorningStar_8001', 'WarMaul_8001', 'ArmingSword_8001', 'CrystalSword_8001', 'StilettoDagger_8001', 'HeaterShield_8001', 'RoundShield_8001', 'Longbow_8001', 'RecurveBow_8001', 'BattleAxe_8001', 'WizardStaff_8001', 'Quarterstaff_8001', 'Spellbook_8001', 'Zweihander_8001', 'HorsemansAxe_8001', 'SurvivalBow_8001', 'Spear_8001']

import os

DATA_DIR = "data"
MODEL_DIR = "models"

WEAPONS_FILE = os.path.join(DATA_DIR, "weapon_dict.json")
OUTPUT_FILE = os.path.join(DATA_DIR, "output.ndjson")
CLEAN_DATA_FILE = os.path.join(DATA_DIR, "clean_data.csv")
MODEL_FILE = os.path.join(MODEL_DIR, "random_forest_model.pkl")

import json

weapon_dict = {}
with open(WEAPONS_FILE, "r", encoding="utf-8") as f:
    weapon_dict = json.load(f)


if __name__ == "__main__":
    import json
    import requests
    import time
    import json
    ppids = set()
    spids = set()
    data = []
    long = 0
    item = None

    with open("output.ndjson", "r", encoding="utf-8") as file:
        for line in file:
            data.append(json.loads(line))

    for k in data:
        for item in k["chats"][0]["chatData"]["chatDataPieceArray"]:
            info = item["chatDataPieceItem"]
            if "pp" in info:
                for pp in info["pp"]:
                    ppids.add(pp["pid"])
            if "sp" in info:
                for sp in info["sp"]:
                    spids.add(sp["pid"])

    ppids = list(ppids)
    spids = list(spids)
    print(f"ppids = {ppids}")
    print(f"spids = {spids}")

    columns = ["message", "rarity", "name", "id"]
    for ppid in ppids:
        column = "pp_" + ppid
        columns.append(column)
    for spid in spids:
        column = "sp_" + spid
        columns.append(column)
        
    print(f"columns = {columns}")

    iids = set()
    for k in data:
        for item in k["chats"][0]["chatData"]["chatDataPieceArray"]:
            info = item["chatDataPieceItem"]
            iid = info["iid"]
            message = item["chatStr"]
            if "pp" in info:
                iids.add(iid)
                for pp in info["pp"]:
                    pass
            if "sp" in info:
                iids.add(iid)
                for sp in info["sp"]:
                    pass
    weapon_ids = []
    for iid in iids:
        if "8" in iid:
            weapon_ids.append(iid)

    print(f"weapon_ids = {weapon_ids}")

    base_url = "https://api.darkerdb.com/v1/items/"

    weapon_dict = {}

    for wid in weapon_ids:
        url = base_url + wid
        try:
            response = requests.get(url)
            response.raise_for_status()
            data = response.json()
            weapon_dict[wid] = data.get("body", {})
        except requests.exceptions.HTTPError as e:
            print(f"Failed to fetch {wid}: {e}")
        time.sleep(0.1)

    with open("weapon_dict.json", "w", encoding="utf-8") as f:
        json.dump(weapon_dict, f, ensure_ascii=False, indent=2)
